---
lab:
    title: 'VNet Peering and Service Chaining'
    module: 'Module 05 - Intersite Connectivity'
---

# 演習 : 仮想ネットワーク ピアリングとサービス チェイニング

この演習のすべての作業には、Azure ポータル (PowerShell クラウド シェル セッションを含む) を使用します。ただし、リモート デスクトップからの Azure 仮想マシンでの操作を含む、演習 2 の作業 3 と演習 3 の作業 1 と作業 2 は除きます。

演習用ファイル :

- **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_01_azuredeploy.json**

- **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_02_azuredeploy.json**

- **Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_azuredeploy.parameters.json**

### シナリオ

Adatum Corporation は、Azure サブスクリプションで Azure 仮想ネットワーク間のサービス チェイ ニングを実装したいと考えています。


### 目的

この演習を修了すると、次のことができるようになります。

- Azure Resource Manager テンプレートを使用して、Azure 仮想ネットワークを作成し、Azure 仮想マシンを展開する。

- 仮想ネットワーク ピアリングを設定する。

- カスタム ルーティングを実装する。

- サービス チェイニングを検証する。


### 演習 0 : 演習環境を準備する

この演習の主な作業は次のとおりです。

1. Azure Resource Manager テンプレートを使用して、2 つの Azure 仮想マシンをホストする最初の仮想ネットワークを作成する。

1. Azure Resource Manager テンプレートを使用して、同じリージョンに単一の Azure 仮想マシンを ホストする 2 番目の仮想ネットワークを作成する。

#### 作業 1 : Azure Resource Manager テンプレートを使用して、2 つの Azure 仮想マシンをホストする最初の仮想ネットワークを作成する

1. 演習用の仮想マシンで、Microsoft Edge を起動します。[**http://portal.azure.com**](http://portal.azure.com) から Azure ポータル にアクセスします。演習用の Azure サブスクリプションの所有者ロールをもつ Microsoft アカウントでサインインします。

1. Azure ポータルから [**リソースの作成**] ブレードを開きます。

1. [**リソースの作成**] ブレードの、Azure Marketplace の検索ボックスに「**Template deployment**」と入力します。

1. 検索結果から [**テンプレートのデプロイ**] ブレードを開き、[**作成**] をクリックします。

1. [**カスタム デプロイ**] ブレードで、[**エディターで独自のテンプレートを作成する**] リンクをクリックします。このリンクが確認できない場合は [**テンプレートの編集**] をクリックします。

1. [**テンプレートの編集**] ブレードで、テンプレート ファイルを読み込みます。**Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_01_azuredeploy.json**.

   > **注** : テンプレートの内容を確認してください。ここでは、Windows Server 2016 Datacenter をホストする Azure 仮想マシンの展開を定義しています。

1. このテンプレートを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードから、[**パラメーターの編集**] ブレードを開きます。

1. [**パラメーターの編集**] ブレードで、パラメーター ファイルを読み込みます。**Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_azuredeploy.parameters.json**.

1. パラメーターを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードで、次の設定を行い、[購入] をクリックして展開を開始します。

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リソース グループ :「**az1000401-RG**」という名前のリソース グループを新規作成します。

   - 場所 : 演習環境に最も近い Azure リージョンの中で、Azure 仮想マシンをプロビジョ二ングできる場所を選択します。

   - Vm Size: **Standard_DS2_v2**

   - Vm1Name: **az1000401-vm1**

   - Vm2Name: **az1000401-vm2**

   - Admin Username : **Student**

   - Admin Password : **Pa55w.rd1234**

   - Virtual Network Name: **az1000401-vnet1**
   > **注** : Azure 仮想マシンをプロビジョニングできる Azure リージョンを確認するには、こちらを参照してください。[**https://azure.microsoft.com/en-us/regions/offers/**](https://azure.microsoft.com/en-us/regions/offers/)

   > **注** : 展開が完了するのを待つ必要はありません。次の作業に進んでください。現在展開中のネットワークと仮想マシンは、演習 2 で使用します。


#### 作業 2 : Azure Resource Manager テンプレートを使用して、同じリージョンに単一の Azure 仮想マシンを ホストする 2 番目の仮想ネットワークを作成する

1. Azure ポータルから [**リソースの作成**] ブレードを開きます。

1. [**リソースの作成**] ブレードの、Azure Marketplace の検索ボックスに「**Template deployment**」と入力します。

1. 検索結果から [**テンプレートのデプロイ**] ブレードを開き、[**作成**] をクリックします。

1. [**カスタム デプロイ**] ブレードで、[**エディターで独自のテンプレートを作成する**] リンクをクリックします。このリンクが確認できない場合は [**テンプレートの編集**] をクリックします。

1. [**テンプレートの編集**] ブレードで、テンプレート ファイルを読み込みます。**Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_02_azuredeploy.json**.

   > **注** : テンプレートの内容を確認してください。ここでは、Windows Server 2016 Datacenter をホストする Azure 仮想マシンの展開を定義しています。

1. このテンプレートを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードから、[**パラメーターの編集**] ブレードを開きます。

1. [**パラメーターの編集**] ブレードで、パラメーター ファイルを読み込みます。**Labfiles\\Module_05\VNet_Peering_and_Service_Chaining\\az-100-04_azuredeploy.parameters.json**.

1. パラメーターを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードで、次の設定を行い、[購入] をクリックして展開を開始します。

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リソース グループ :「**az1000402-RG**」という名前のリソース グループを新規作成します。

   - 場所 : 前の作業で選択した Azure リージョン

   - Vm Size: **Standard_DS2_v2**

   - VmName: **az1000402-vm3**

   - Admin Username : **Student**

   - Admin Password : **Pa55w.rd1234**

   - Virtual Network Name: **az1000402-vnet2**
   > **注** : 展開が完了するのを待つ必要はありません。次の作業に進んでください。現在展開中のネットワークと仮想マシンは、演習 2 で使用します。

> **結果**: この演習では、Azure Resource Manager テンプレートを使用して 2 つの Azure 仮想ネットワークを作成し、3 つの Azure 仮想マシンの展開を開始しました。


### 演習 1 : 仮想ネットワーク ピアリングを設定する

この演習の主な作業は次のとおりです。

1. 1 つ目の仮想ネットワークに仮想ネットワーク ピアリングを設定する

1. 2 つ目の仮想ネットワークに仮想ネットワーク ピアリングを設定する


#### 作業 1 : 1 つ目の仮想ネットワークに仮想ネットワーク ピアリングを設定する

1. Azure ポータルから [**az1000401-vnet1**] 仮想ネットワーク ブレードを開きます。

1. [**az1000401-vnet1**] 仮想ネットワーク ブレードで、[**ピアリング**] ブレードを開きます。

1. [**az1000401-vnet1 - ピアリング**] ブレードの、[**+ 追加**] をクリックして、次のような設定の仮想ネットワーク ピアリングを作成します。

   - az1000402-vnet1 からリモート仮想ネットワークへのピアリングの名前 : **az1000401-vnet1-to-az1000402-vnet2**

   - 仮想ネットワークのデプロイ モデル : **Resource manager**

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - 仮想ネットワーク : **az1000402-vnet2**

   - az1000402-vnet2 から az1000401-vnet1 へのピアリングの名前 : **az1000402-vnet2-to-az1000401-vnet1**

   - 仮想ネットワーク アクセス設定の構成 : **有効**

   - 転送トラフィック設定の構成 : **無効**

   - ゲートウェイ転送設定の構成 : **無効**

> **注** : 両方の仮想ネットワークへの管理アクセスがあるため、ポータルは一度に両方向 (vnet1 から vnet2、vnet2 から vnet1) の設定を構成しています。CLI、PowerShell、REST API からは、これらの作業は別個に実行する必要があります。


### 演習 2 : カスタム ルーティングを実装する

この演習の主な作業は次のとおりです。

1. Azure 仮想マシンのネットワーク インターフェイスの IP 転送を有効にする

1. ユーザー定義ルーティングを設定する

1. Windows Server 2016 を実行している Azure 仮想マシンでルーティングを構成する


#### 作業 1 : Azure 仮想マシンのネットワーク インターフェイスの IP 転送を有効にする

> **注** : この作業を始める前に、演習 0 で開始したテンプレートの展開が完了していることを確認してください。

1. Azure ポータルから、2 つ目の Azure 仮想マシン [**az1000401-vm2**] を開きます。

1. [**az1000401-vm2**] ブレードで、[**ネットワーク**] ブレードを開きます。

1. [**az1000401-vm2 - ネットワーク**] ブレードから、Azure 仮想マシンのネットワーク アダプター (**az1000401-nic2**) を表示します。

1. [**az1000401-nic2**] ブレードで、[**IP 構成**] ブレードを表示します。

1. [**az1000401-nic2 - IP 構成**] で、IP 転送を **有効** に設定し、[**保存**] します。

   > **注** : この作業でネットワーク インターフェイスを設定した "**az1000401-vm2**" という仮想マシンは、ルーターとして機能し、2 つの仮想ネットワーク間のサービスチェイニングを容易にします。


#### 作業 2 : ユーザー定義ルーティングを設定する

1. Azure ポータルから [**リソースの作成**] ブレードを開きます。

1. **リソースの作成**] ブレードの、Azure Marketplace の検索ボックスに「**Route table**」と入力します。

1. [**Route table**] を選択し [**作成**] をクリックします。

1. [**ルート テーブルの作成**] ブレードで、次のような設定のルート テーブルを作成します。

   - 名前 : **az1000402-rt1**

   - サブスクリプション : この演習で使用している Azure サブスクリプション

   - リソース グループ : **az1000402-RG**

   - 場所 : 仮想ネットワークを作成した Azure リージョン

   - 仮想ネットワーク ゲートウェイの伝達 : **無効**

1. Azure ポータルから [**az1000402-rt1**] ブレードを開きます。

1. [**az1000402-rt1**] ブレードから、[**ルート**] ブレードを開きます。

1. [**az1000402-rt1 - ルート**] ブレードで、次のような設定のルート テーブルを追加します。

   - ルート名 : **custom-route-to-az1000401-vnet1**

   - アドレス プレフィックス : **10.104.0.0/16**

   - 次ホップの種類 : **仮想アプライアンス**

   - 次ホップ アドレス : **10.104.1.4**
   > **注** : **10.104.1.4** は、**az1000401-vm2** のネットワーク インターフェイスの IP アドレスであるため、2 つの仮想ネットワーク間のサービス チェイニングを提供します。

1. [**az1000402-rt1**] ブレードで、[**サブネット**] ブレードを表示します。

1. [**az1000402-rt1 - サブネット**] ブレードで、[**関連付け**] をクリックし、次のような設定でルート テーブル **az1000402-rt1**と "**az1000402-vnet2**" の "**subnet0**" を関連付けます。

   - 仮想ネットワーク : **az1000402-vnet2**

   - サブネット : **subnet0**
   

#### 作業 3 : Windows Server 2016 を実行している Azure 仮想マシンでルーティングを構成する

1. Azure ポータルで、仮想マシン [**az1000401-vm2**] ブレードを開きます。

1. [**az1000401-vm2**] ブレードの [**概要**] ペインで、[**az1000401-vm2**] に接続するための RDP ファイルを生成します。

1. プロンプトが表示されたら、次の資格情報を指定して認証します。

   - ユーザー名 : **Student**

   - パスワード : **Pa55w.rd1234**

1. [**az1000401-vm2**] へのリモート デスクトップ セッションで、**Server Manager**の [**Manage**] から [**Add Roles and Features**] をクリックします。

1. [**Add Roles and Features Wizard**] 画面で、次のような設定でサーバーの役割を追加します。

   - Server Roles : **Remote Access**

   - Role Services : **Routing**

   - Add features that are required Routing? : **Add Features**

   > **注** : エラー メッセージが出る場合は、**設定先のサーバーまたは VHD とこの PC のバージョンが違っていることが考えられます。[**Add Roles and Features Wizard**] の [**Server Roles**] ページで** 一度 [**Remote Access**] のチェックボックスを選択したら、[**Next**] をクリックし、[**Previous**] で戻ってから再度[**Remote Access**] のチェックボックスを選択します。

1. [**az1000401-vm2**] へのリモート デスクトップ セッションで、サーバー マネージャー から [**Routing and Remote Access**] コンソールを開きます。

1. [**Routing and Remote Access**] コンソールで、サーバー名を右クリックし、[**Configure and Enable Routing and Remote Access**] をクリックし、[**Custom configuration**] オプションを選択し、[**LAN routing**] を有効にします。そして、[**Routing and Remote Access**] を開始します。

1. [**az1000401-vm2**] へのリモート デスクトップ セッションで、[**Windows Firewall with Advanced Security**] コンソールを開き、[**Inbound Rules**] をクリックし、[**Profile**] 欄が [**All**] と表示されている [**File and Printer Sharing (Echo Request - ICMPv4-In)**] 受信規則を有効にします。

> **結果**: この演習では、ピアリングされた Azure 仮想ネットワーク間にカスタム ルーティングを実装しました。


### 演習 3 : サービス チェイニングを検証する

この演習の主な作業は次のとおりです。

1. ターゲット Azure 仮想マシンでセキュリティが強化された Windows ファイアウォールを構成する。

1. ピアリングされた仮想ネットワーク間のサービス チェイニングを検証する。


#### 作業 1 : ターゲット Azure 仮想マシンでセキュリティが強化された Windows ファイアウォールを構成する

1. Azure ポータルから、仮想マシン [**az1000401-vm1**] ブレードを開きます。

1. [**az1000401-vm1**] ブレードの [**概要**] ペインから、**az1000401-vm1** に接続するための RDP ファイルを生成します。

1. プロンプトが表示されたら、次の資格情報を指定して認証します。

   - ユーザー名 : **Student**

   - パスワード : **Pa55w.rd1234**

1. [**az1000401-vm1**] へのリモート デスクトップ セッションから、[**Windows Firewall with Advanced Security**] コンソールを開き、[**Inbound Rules**] をクリックし、[**Profile**] 欄が [**All**] と表示されている [**File and Printer Sharing (Echo Request - ICMPv4-In)**] 受信規則を有効にします。


#### 作業 2 : ピアリングされた仮想ネットワーク間のサービス チェイニングを検証する

1. Azure ポータルから、仮想マシン [**az1000402-vm3**] ブレードを開きます。

1. [**az1000402-vm3**] ブレードの [**概要**] ペインで、[**az1000402-vm3**] に接続するための RDP ファイルを生成します。

1. プロンプトが表示されたら、次の資格情報を指定して認証します。

   - ユーザー名 : **Student**

   - パスワード : **Pa55w.rd1234**

1. [**az1-1000402-vm3**] へのリモート デスクトップ セッションが成立したら、**Windows PowerShell** を起動します。

1. **Windows PowerShell** ウィンドウで、次のコマンドを実行します。

   ```pwsh
   Test-NetConnection -ComputerName 10.104.0.4 -TraceRoute
   ```

   > **注 **: "**10.104.0.4**" は、1 つ目の仮想マシン [**az1000401-vm1**] のネットワーク インターフェイスの IP アドレスです。

1. 検証結果を確認し、**10.104.1.4** 経由の接続が行われたことを確認します。

   > **注** : カスタムルーティングが設定されていない場合は、2 つの Azure 仮想マシン間で直接トラフィックが生じます。
> **結果**: この演習では、ピアリングされた Azure 仮想ネットワーク間のサービス チェイニングを検証しました。

## 演習 4 : 演習用リソースを削除する

#### 作業 1 : Cloud Shell を開く

1. Azure ポータルの上部にある **Cloud Shell** アイコンをクリックして、Cloud Shell ペインを開きます。

1. Cloud Shell インターフェイスで [**Bash**] を選択します。

1. **Cloud Shell** のコマンド プロンプトで、次のコマンドを入力し [**Enter**] を押します。これにより、この演習で作成したすべてのリソース グループが表示されます。

   ```sh
   az group list --query "[?starts_with(name,'az1000')].name" --output tsv
   ```

1. 出力結果を確認し、リストにはこの演習で作成したリソース グループのみが含まれることを確認します。これらのリソース グループを、次の作業で削除します。

#### 作業 2 : リソース グループを削除する

1. **Cloud Shell** のコマンド プロンプトで、次のコマンドを入力し [**Enter**] を押します。これにより、この演習で作成したリソース グループを削除できます。

   ```sh
   az group list --query "[?starts_with(name,'az1000')].name" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
   ```

1. ポータルの下部に表示される **Cloud Shell** プロンプトを閉じます。

> **結果** : この演習では、演習内で使用したリソースをすべて削除しました。
