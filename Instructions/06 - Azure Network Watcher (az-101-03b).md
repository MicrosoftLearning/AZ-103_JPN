---
lab:
    title: 'Azure Network Watcher'
    module: 'Module 06 - Monitoring'
---

# 演習 : Network Watcher

この演習のすべての作業には、Azure ポータル (PowerShell クラウド シェル セッションを含む) を使用します。

> **Note** : クラウド シェルを使用しない場合は、Azure PowerShell 1.2.0 (またはそれ以降の) モジュールをインストールした演習用仮想マシンが必要となります。[https://docs.microsoft.com/en-us/powershell/azure/install-az-ps](https://docs.microsoft.com/en-us/powershell/azure/install-az-ps)

演習用ファイル :

- **Labfiles\\Module_06\\Network_Watcher\\az-101-03b_01_azuredeploy.json**

- **Labfiles\\Module_06\\Network_Watcher\\az-101-03b_02_azuredeploy.json**

- **Labfiles\\Module_06\\Network_Watcher\\az-101-03b_01_azuredeploy.parameters.json**

- **Labfiles\\Module_06\\Network_Watcher\\az-101-03b_02_azuredeploy.parameters.json**


### シナリオ

Adatum Corporation は、Azure Network Watcher を使用して Azure 仮想ネットワーク接続を監視したいと考えています。


### 目的

この演習を修了すると、次のことができるようになります。

- Azure Resource Manager テンプレートを使用して Azure 仮想マシン、Azure ストレージ アカウント、および Azure SQL Database インスタンスを展開する。

- Azure Network Watcher を使用してネットワーク接続を監視する。


### 演習1 : Azure Network Watcher ベースの監視のためのインフラストラクチャを準備する

この演習の主な作業は次のとおりです。

1. Azure Resource Manager テンプレートを使用して、Azure 仮想マシン、Azure ストレージ アカウント、および Azure SQL Database インスタンスを展開する。

1. Azure Network Watcher サービスを有効にする。

1. Azure 仮想ネットワーク間のピアリングを確立する。

1. Azure ストレージ アカウントと Azure SQL Database インスタンスへのサービス エンドポイントを確立する。


#### 作業 1 : Azure Resource Manager テンプレートを使用して、Azure 仮想マシン、Azure ストレージ アカウント、および Azure SQL Database インスタンスを展開する

1. 演習用の仮想マシンで、Microsoft Edge を起動します。[**http://portal.azure.com**](http://portal.azure.com) から Azure ポータル にアクセスします。演習用の Azure サブスクリプションの所有者ロールをもつ Microsoft アカウントでサインインします。

1. Azure ポータルから [**リソースの作成**] ブレードを開きます。

1. [**リソースの作成**] ブレードの、Azure Marketplace の検索ボックスに「**Template deployment**」と入力します。

1. 検索結果から [**テンプレートのデプロイ**] を開き、[**作成**] をクリックします。

1. [**カスタム デプロイ**] ブレードで、[**エディターで独自のテンプレートを作成する**] リンクをクリックします。このリンクが確認できない場合は [**テンプレートの編集**] をクリックします。

1. [**テンプレートの編集**] ブレードで、テンプレート ファイルを読み込みます。 **az-101-03b_01_azuredeploy.json**.

   > **注** : テンプレートの内容を確認してください。このテンプレートでは、Azure 仮想マシン、Azure SQL Database、Azure ストレージ アカウントの展開を定義しています。

1. このテンプレートを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードから、[**パラメーターの編集**] ブレードを開きます。

1. [**パラメーターの編集**] ブレードで、パラメーター ファイルを読み込みます。**az-101-03b_01_azuredeploy.parameters.json**.

1. パラメーターを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードで、次の設定を行い、[購入] をクリックして展開を開始します。

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リソース グループ : 「**az1010301b-RG**」という名前のリソース グループを新規作成します。

   - ロケーション : 演習環境に最も近い Azure リージョンの中で、Azure 仮想マシンと Azure SQL Databaseをプロビジョ二ングできる場所を選択します。

   - Vm Size: **Standard_DS2_v2**

   - Vm Name: **az1010301b-vm1**

   - Admin Username : **Student**

   - Admin Password : **Pa55w.rd1234**

   - Virtual Network Name: **az1010301b-vnet1**

   - Sql Login Name: **Student**

   - Sql Login Password: **Pa55w.rd1234**

   - Database Name: **az1010301b-db1**

   - Sku Name: **Basic**

   - Sku Tier: **Basic**
   > **注** : 指定したリージョンとサブスクリプションで利用可能な仮想マシンのサイズを確認する場合は、CloudShell で次のコマンドを実行します。そして、出力結果の [**Restriction**] 列の値を確認します。(&lt;location&gt; には指定したリージョンを入力します。例えば、東日本であれば **japaneast** と入力します。)

   ```pwsh
   Get-AzComputeResourceSku | where {$_.Locations -icontains "<location>"} | Where-Object {($_.ResourceType -ilike "virtualMachines")}
   ```

   > **注** : 指定したリージョンで Azure SQL Database をプロビジョニングできるかどうかを確認する場合は、CloudShell で次のコマンドを実行します。そして、出力結果の[**Status**] 列が "**Available**" であることを確認します。(&lt;location&gt; には指定したリージョンを入力します。例えば、東日本であれば **japaneast** と入力します。)

   ```pwsh
   Get-AzSqlCapability -LocationName <regionname>
   ```

   > **注** : 展開が完了するのを待つ必要はありません。次の手順に進んでください。

1. Azure ポータルから [**リソースの作成**] ブレードを開きます。

1. [**リソースの作成**] ブレードの、Azure Marketplace の検索ボックスに「**Template deployment**」と入力します。

1. 検索結果から [**テンプレートのデプロイ**] を開き、[**作成**] をクリックします。

1. [**カスタム デプロイ**] ブレードで、[**エディターで独自のテンプレートを作成する**] リンクをクリックします。このリンクが確認できない場合は [**テンプレートの編集**] をクリックします。

1. [**Edit template**] ブレードで、テンプレート ファイルを読み込みます。**az-101-03b_02_azuredeploy.json**.

   > **注** : テンプレートの内容を確認し、Azure 仮想マシンの展開が定義されていることを確かめます。

1. このテンプレートを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードから、[**パラメーターの編集**] ブレードを開きます。

1. [**パラメーターの編集**] ブレードで、パラメーター ファイルを読み込みます。**az-101-03b_02_azuredeploy.parameters.json**

1. パラメーターを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードで、次の設定を行い、[購入] をクリックして展開を開始します。

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リソース グループ : 「**az1010302b-RG**」という名前のリソース グループを新規作成します。

   - ロケーション : Azure 仮想マシンをプロビジョニングできるリージョンを指定しますが、先ほどの展開とは **異なる** リージョンを指定します。

   - Vm Size: **Standard_DS2_v2**

   - Vm Name: **az1010302b-vm2**

   - Admin Username : **Student**

   - Admin Password : **Pa55w.rd1234**

   - Virtual Network Name: **az1010302b-vnet2**
   > **注** : 前の作業とは別の Azure リージョンを指定していることを確認してください。

   > **注** : 展開が完了するのを待つ必要はありません。次の手順に進んでください。


#### 作業 2 : Azure Network Watcher サービスを有効にする

1. Azure ポータルで、[**すべてのサービス**] ブレードを開き、検索ボックスに「**Network Watcher**」と入力し、Network Watcher ブレードを開きます。

2. [**Network Watcher**] ブレードで、[地域] 列の矢印をクリックし、先ほどの作業でリソースを展開した 2 つのリージョンで Network Watcher が有効になっていることを確認します。もし無効になっている場合は、有効化します。


#### 作業 3 : Azure 仮想ネットワーク間のピアリングを確立する

> **注** : この作業を開始する前に、作業 1 で開始したテンプレートの展開が完了していることを確認してください。

1. Azure ポータルから、仮想ネットワーク [**az1010301b-vnet1**] ブレードを開きます。

1. 仮想ネットワーク [**az1010301b-vnet1**] ブレードから [**ピアリング**] ブレードを開きます。

1. [**az1010301b-vnet1 - ピアリング**] ブレードで、[追加] をクリックし、次のような設定の仮想ネットワーク ピアリングを確率します。

   - az1010301b-vnet1 からリモート仮想ネットワークへのピアリングの名前 : **az1010301b-vnet1-to-az1010302b-vnet2**

   - 仮想ネットワークのデプロイ モデル : **Resource manager**

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - 仮想ネットワーク : **az1010302b-vnet2**

   - az1010302b-vnet2 から az1010301b-vnet1 へのピアリングの名前 : **az1010302b-vnet2-to-az1010301b-vnet1**

   - 仮想ネットワーク アクセス設定の構成 : **有効**

   - 転送トラフィック設定の構成 : **無効**

   - ゲートウェイ転送の構成 : 無効
   > **注** : Azure ポータルでは、ポータルは一度に両方向 (vnet1 から vnet2、vnet2 から vnet1) の設定を構成しています。他の管理ツールを使用する場合は、各方向を個別に構成する必要があります。

#### 作業 4 : Azure ストレージ アカウントと Azure SQL Database インスタンスへのサービス エンドポイントを確立する

1. Azure ポータルから、仮想ネットワーク [**az1010301b-vnet1**] ブレードを開きます。

1. 仮想ネットワーク [**az1010301b-vnet1**] ブレードから [**サービス エンドポイント**] ブレードを開きます。

1. [**az1010301b-vnet1 - サービス エンドポイント**] ブレードで、‘[追加] をクリックし、次のような設定のサービス エンドポイントを確立します。

   - サービス : **Microsoft.Storage**

   - サブネット : **subnet0**

1. この手順を繰り返し、2 つ目のサービス エンドポイントを作成します。

   - サービス : **Microsoft.Sql**

   - サブネット : **subnet0**

1. Azure ポータルから、リソース グループ [**az1010301b-RG**] ブレードを開きます。

1. リソース グループ [**az1010301b-RG**] ブレードで、リソース グループ内のストレージ アカウントを開きます。

1. ストレージ アカウント ブレードで、[**ファイアウォールと仮想ネットワーク**] ブレードを開きます。

1. [**ファイアウォールと仮想ネットワーク**] ブレードで、次のような設定を行います。

   - 許可するアクセス元 : **選択されたネットワーク**

   - 仮想ネットワーク : [**既存の仮想ネットワークを追加**] をクリックして、次のような設定を行います。

      - VIRTUAL NETWORK : **az1010301b-vnet1**

      - サブネット : **subnet0**
   - ファイアウォール : 

      - アドレス範囲 : なし
   - 例外 : 

      - 信頼された Microsoft サービスによるこのストレージ アカウントに対するアクセスを許可します : **有効**

      - すべてのネットワークからのストレージ ログに対する読み取りアクセスを許可します : **無効**

      - すべてのネットワークからのストレージ メトリックに対する読み取りアクセスを許可します : **無効**



1. Azure ポータルから、リソース グループ [**az1010301b-RG**] ブレードを開きます。

1. リソース グループ [**az1010301b-RG**] ブレードで、リソース グループ内の  Azure SQL Server ブレードを開きます。

1. Azure SQL Server ブレードで、[**ファイアウォールと仮想ネットワーク**] ブレードを開きます。

1. Azure SQL Server ブレードの [**ファイアウォールと仮想ネットワーク**] で次のような設定を行います

   - Azure サービスへのアクセスを許可 : **ON**

   - 「ファイアウォール規則が構成されていません。」という状態。

   - 仮想ネットワーク : [**既存の仮想ネットワークを追加**] をクリックして、次のような設定を行います。

      - 名前 : **az1010301b-vnet1**

      - サブスクリプション : この演習で使用しているサブスクリプション名

      - 仮想ネットワーク : **az1010301b-vnet1**

      - サブネット名 / アドレス プレフィックス : **subnet0/ 10.203.0.0/24**

> **結果** : この演習では、Azure Resource Manager テンプレートを使用して Azure 仮想マシン、Azure ストレージ アカウント、および Azure SQL Database インスタンスを展開しました。また、Azure Network Watcher サービスを有効にし、Azure 仮想ネットワーク間のグローバル ピアリングを確立し、サービス エンドポイントをAzure ストレージ アカウントと Azure SQL Database インスタンスに確立しました。


### 演習2 : Azure Network Watcher を使用してネットワーク接続を監視する

この演習の主な作業は次のとおりです。

1. Network Watcher を使用して仮想ネットワーク ピアリングを介して Azure 仮想マシンへのネットワーク接続を検証する。

1. Network Watcher を使用して Azure ストレージ アカウントへのネットワーク接続を検証する。

1. Network Watcher を使用して Azure SQL Database へのネットワーク接続を検証する。


#### 作業 1 : Network Watcher を使用して仮想ネットワーク ピアリングを介して Azure 仮想マシン へのネットワーク接続を検証する

1. Azure ポータルから、[**Network Watcher**] ブレードを開きます。

1. [**Network Watcher**] ブレードの [**接続のトラブルシューティング**] を開きます。

1. [**Network Watcher - 接続のトラブルシューティング**] ブレードで、次のように設定した上で [チェック] を行います。

   - ソース : 

      - サブスクリプション : この演習で使用しているサブスクリプション名

      - リソース グループ : **az1010301b-RG**

      - ソースの種類 : **仮想マシン**

      - 仮想マシン : **az1010301b-vm1**
   - 宛先 : **手動で設定**

      - URI、FQDN または IPv4 : **10.203.16.4**
      > **注** : **10.203.16.4** は、別の Azure リージョンに展開した 2 つ目の Azure 仮想マシンのプライベート IP アドレスです。

   - プローブ設定 :

      - プロトコル : **TCP**

      - 宛先のポート : **3389**
   - 詳細設定 : 

      - 発信元ポート : 空白




1. 接続を調べた結果が出るまで待ちます。結果が "**到達可能**" であることを確認します。チェック結果のネットワーク パスを確認し、2 つの仮想マシン間にホップはなく、直接接続していることを確認してください。

   > **注** : Network Watcher を初めて使用する場合は、このチェック処理は 5 分程度かかる可能性があります。


#### 作業 2 : Network Watcher を使用して Azure ストレージ アカウントへのネットワーク接続を検証する

1. Azure ポータル の Cloud Shell ペインから、PowerShell セッションを開始します。

   > **注** : 現在の Azure サブスクリプションで Cloud Shell を初めて起動する場合、Cloud Shell ファイルを維持するための Azure ファイル共有の作成を要求されます。既定のまま設定すると、自動生成されたリソース グループにストレージ アカウントが作成されます。

1. Cloud Shell ペインで、次のコマンドを実行し、 前の演習でプロビジョニングした Azure ストレージ アカウントの BLOB サービス エンドポイントの IP アドレスを特定します。

   ```pwsh
   [System.Net.Dns]::GetHostAddresses($(Get-AzStorageAccount -ResourceGroupName 'az1010301b-RG')[0].StorageAccountName + '.blob.core.windows.net').IPAddressToString
   ```

1. 出力結果を確認し、IP アドレスを控えておきます。[**Network Watcher - 接続のトラブルシューティング**] ブレードを開き、次のように設定した上で [チェック] を行います。

   - ソース : 

      - サブスクリプション : この演習で使用しているサブスクリプション名

      - リソース グループ : **az1010301b-RG**

      - ソースの種類 : **仮想マシン**

      - 仮想マシン : **az1010301b-vm1**
   - 宛先 : **手動で設定**

      - URI、FQDN または IPv4 : 前の手順で確認した、ストレージ アカウントの BLOB サービスエンドポイントの IP アドレス
   - プローブ設定 :

      - プロトコル : **TCP**

      - 宛先のポート : **443**
   - 詳細設定 : 

      - 発信元ポート : 空白




1. 接続を調べた結果が出るまで待ちます。結果が "**到達可能**" であることを確認します。チェック結果のネットワーク パスを確認し、2 つの仮想マシン間にホップはなく、最小待機時間で直接接続していることを確認してください。

   > **注** : この接続は、演習 1 で作成したサービス エンドポイントを介して行われます。これを検証するためには、Network Watcher の [**次ホップ**] を確認します。

1. [**Network Watcher - 接続のトラブルシューティング**] ブレードから、[**Network Watcher - 次ホップ**] ブレードに移動し、次のように次ホップを設定し、検証します。

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リソース グループ : **az1010301b-RG**

   - 仮想マシン : **az1010301b-vm1**

   - ネットワーク インターフェイス : **az1010301b-nic1**

   - ソース IP アドレス : **10.203.0.4**

   - 接続先 IP アドレス :  前の手順で確認した、ストレージ アカウントの BLOB サービスエンドポイントの IP アドレス

1. 検証結果を確認し、次ホップの種類が "**VirtualNetworkServiceEndpoint**" となっていることを確かめます。

1. [**Network Watcher - 接続のトラブルシューティング**] ブレードで、次のように設定した上で [チェック] を行います。

   - ソース : 

      - サブスクリプション : この演習で使用しているサブスクリプション名

      - リソース グループ : **az1010302b-RG**

      - ソースの種類 : **仮想マシン**

      - 仮想マシン : **az1010302b-vm2**
   - 宛先 : **手動で設定**

      - URI、FQDN または IPv4 : 前の作業で確認した、ストレージ アカウントの BLOB サービスエンドポイントの IP アドレス
   - プローブ設定 :

      - プロトコル : **TCP**

      - 宛先のポート : **443**
   - 詳細設定 : 

      - 発信元ポート : 空白

   > **注** : Network Watcher による、このチェック処理は 5 分程度かかる可能性があります。


1. 接続を調べた結果が出るまで待ちます。結果が "**到達可能**" であることを確認します。

   > **注** : 接続は成功していますが、この接続はインターネットを経由しています。これを検証するためには、再度 Network Watcher の [**次ホップ**] ツールを確認します。

1. [**Network Watcher - 接続のトラブルシューティング**] ブレードから、[**Network Watcher - 次ホップ**] ブレードに移動し、次のように次ホップを設定し、検証します。

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リソース グループ : **az1010302b-RG**

   - 仮想マシン : **az1010302b-vm2**

   - ネットワーク インターフェイス : **az1010302b-nic1**

   - ソース IP アドレス : **10.203.16.4**

   - 接続先 IP アドレス :  前の手順で確認した、ストレージ アカウントの BLOB サービスエンドポイントの IP アドレス

1. 検証結果を確認し、次ホップの種類が "**Internet**" であることを確かめます。


#### 作業 3 : Network Watcher を使用して Azure SQL Database へのネットワーク接続を検証する

1. Azure ポータル の Cloud Shell ペインから、PowerShell セッションを開始します。

1. Cloud Shell ペインで、次のコマンドを実行し、 前の演習でプロビジョニングした Azure SQL Database サーバーの BLOB サービス エンドポイントの IP アドレスを特定します。

   ```pwsh
   [System.Net.Dns]::GetHostAddresses($(Get-AzSqlServer -ResourceGroupName 'az1010301b-RG')[0].FullyQualifiedDomainName).IPAddressToString
   ```

1. 出力結果を確認し、IP アドレスを控えておきます。[**Network Watcher - 接続のトラブルシューティング**] ブレードを開き、次のように設定した上で [チェック] を行います。

   - ソース : 

      - サブスクリプション : この演習で使用しているサブスクリプション名

      - リソース グループ : **az1010301b-RG**

      - ソースの種類 : **仮想マシン**

      - 仮想マシン : **az1010301b-vm1**
   - 宛先 : **手動で設定**

      - UURI、FQDN または IPv4 : 前の手順で確認した、 Azure SQL Database サーバーの IP アドレス
   - プローブ設定 :

      - プロトコル : **TCP**

      - 宛先のポート : **1433**
   - 詳細設定 : 

      - 発信元ポート : 空白




1. 接続を調べた結果が出るまで待ちます。結果が "**到達可能**" であることを確認します。チェック結果のネットワーク パスを確認し、2 つの仮想マシン間にホップはなく、少ない待機時間で直接接続していることを確認してください。

   > **注** : この接続は、演習 1 で作成したサービス エンドポイントを介して行われます。これを検証するためには、Network Watcher の [**次ホップ**] を確認します。

1. [**Network Watcher - 接続のトラブルシューティング**] ブレードから、[**Network Watcher - 次ホップ**] ブレードに移動し、次のように次ホップを設定し、検証します。

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リソース グループ : **az1010301b-RG**

   - 仮想マシン : **az1010301b-vm1**

   - ネットワーク インターフェイス : **az1010301b-nic1**

   - ソース IP アドレス : **10.203.0.4**

   - 接続先 IP アドレス : 前の手順で確認した、Azure SQL Database サーバーの IP アドレス

1. 検証結果を確認し、次ホップの種類が "**VirtualNetworkServiceEndpoint**" となっていることを確かめます。

1. [**Network Watcher - 接続のトラブルシューティング**] ブレードで、次のように設定した上で [チェック] を行います。

   - ソース : 

      - サブスクリプション : この演習で使用しているサブスクリプション名

      - リソース グループ : **az1010302b-RG**

      - ソースの種類 : **仮想マシン**

      - 仮想マシン : **az1010302b-vm2**
   - 宛先 : **手動で設定**

      - UURI、FQDN または IPv4 : 前の手順で確認した、Azure SQL Database サーバーの IP アドレス
   - プローブ設定 :

      - プロトコル : **TCP**

      - 宛先のポート : **1433**
   - 詳細設定 : 

      - 発信元ポート : 空白




1. 接続を調べた結果が出るまで待ちます。結果が "**到達可能**" であることを確認します。

   > **注** : 接続は成功していますが、この接続はインターネットを経由しています。これを検証するためには、再度 Network Watcher の [**次ホップ**] ツールを確認します。

1. [**Network Watcher - 接続のトラブルシューティング**] ブレードから、[**Network Watcher - 次ホップ**] ブレードに移動し、次のように次ホップを設定し、検証します。

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リソース グループ : **az1010302b-RG**

   - 仮想マシン : **az1010302b-vm2**

   - ネットワーク インターフェイス : **az1010302b-nic1**

   - ソース IP アドレス : **10.203.16.4**

   - 接続先 IP アドレス : 前の手順で確認した、Azure SQL Database サーバーの IP アドレス

1. 検証結果を確認し、次ホップの種類が "**Internet**" であることを確かめます。


> **結果** : この演習では、Azure Network Watcher を使用して、仮想ネットワーク ピアリング、Azure Storage へのネットワーク接続、および Azure SQL Database へのネットワーク接続を介した Azure 仮想マシンへのネットワーク接続を検証しました。

## 演習 3 : 演習用リソースを削除する

#### 作業 1 : Cloud Shell を開く

1. Azure ポータルの上部にある **Cloud Shell** アイコンをクリックして、Cloud Shell ペインを開きます。

1. Cloud Shell インターフェイスで [**Bash**] を選択します。

1. **Cloud Shell** のコマンド プロンプトで、次のコマンドを入力し [**Enter**] を押します。これにより、この演習で作成したすべてのリソース グループが表示されます。

   ```sh
   az group list --query "[?starts_with(name,'az1010')].name" --output tsv
   ```

1. 出力結果を確認し、リストにはこの演習で作成したリソース グループのみが含まれることを確認します。これらのリソース グループを、次の作業で削除します。

#### 作業 2 : リソース グループを削除する

1. **Cloud Shell** のコマンド プロンプトで、次のコマンドを入力し [**Enter**] を押します。これにより、この演習で作成したリソース グループを削除できます。

   ```sh
   az group list --query "[?starts_with(name,'az1010')].name" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
   ```

1. ポータルの下部に表示される **Cloud Shell** プロンプトを閉じます。

> **結果** : この演習では、演習内で使用したリソースをすべて削除しました。
