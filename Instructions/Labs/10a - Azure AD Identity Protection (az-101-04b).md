---
lab:
    title: 'Azure AD Identity Protection'
    module: 'Module 10 - Securing Identities'
---

# 演習 : Azure AD の ID 保護

この演習のすべての作業には、Azure ポータル (PowerShell クラウド シェル セッションを含む) を使用します。ただし、リモート デスクトップからの Azure 仮想マシンでの操作を含む、演習 2 は除きます。

演習用ファイル :

- **Labfiles\\Module_10\\Azure_AD_Identity_Protection\\az-101-04b_azuredeploy.json**

- **Labfiles\\Module_10\\Azure_AD_Identity_Protection\\az-101-04b_azuredeploy.parameters.json**

### シナリオ

Adatum Corporation は、ID 保護のために Azure AD Premium 機能を利用したいと考えています。


### 目的

この演習を修了すると、次のことができるようになります。

- Azure Resource Manager (ARM) テンプレートを使用して Azure 仮想マシンを展開する。

- Azure MFA を実装する。

- Azure AD Identity Protection を実装する。


### 演習 0 : 演習環境を準備する

この演習の主な作業は次のとおりです。

1. Azure Resource Manager (ARM) テンプレートを使用して Azure 仮想マシンを展開する。


#### 作業 1 : Azure Resource Manager (ARM) テンプレートを使用して Azure 仮想マシンを展開する

1. 演習用の仮想マシンで、Microsoft Edge を起動します。[**http://portal.azure.com**](http://portal.azure.com) から Azure ポータル にアクセスします。演習用の Azure サブスクリプションの所有者ロールをもつ Microsoft アカウントでサインインします。

1. Azure ポータルから [**リソースの作成**] ブレードを開きます。

1. [**リソースの作成**] ブレードの、Azure Marketplace の検索ボックスに「**Template deployment**」と入力します。

1. 検索結果から [**テンプレートのデプロイ**] ブレードを開き、[作成] をクリックします。

1. [**カスタム デプロイ**] ブレードで、[**エディターで独自のテンプレートを作成する**] をクリックします。

1. [**テンプレートの編集**] ブレードで、テンプレート ファイルを読み込みます。**az-101-04b_azuredeploy.json**

   > **注** : テンプレートの内容を確認してください。ここでは、Windows Server 2016 Datacenter をホストする Azure 仮想マシンの展開を定義しています。

1. このテンプレートを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードから、[**パラメーターの編集**] ブレードを開きます。

1. [**パラメーターの編集**] ブレードで、パラメーター ファイルを読み込みます。**az-101-04b_azuredeploy.parameters.json**

1. パラメーターを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードで、次の設定を行い、[**購入**] をクリックして展開を開始します。

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リソース グループ : 「**az1010401b-RG**」という名前のリソース グループを新規作成します。

   - 場所 : 演習環境に最も近い Azure リージョンの中で、Azure 仮想マシンをプロビジョ二ングできる場所を選択します。

   - Vm Size : **Standard_DS1_v2**

   - Vm Name : **az1010401b-vm1**

   - Admin Username : **Student**

   - Admin Password : **Pa55w.rd1234**

   - Virtual Network Name : **az1010401b-vnet1**
   > **注** : Azure 仮想マシンをプロビジョニングできる Azure リージョンを確認するには、こちらを参照してください。[**https://azure.microsoft.com/en-us/regions/offers/**](https://azure.microsoft.com/en-us/regions/offers/)

   > **注** : 展開が完了するのを待つ必要はありません。次の演習に進んでください。現在展開中の仮想マシンは、この演習の最後で使用します。

> **結果** : この演習では、 **az1010401b-vm1** という Azure 仮想マシン を展開しました。この仮想マシンは、この演習の次の演習で使用します。


### 演習 1: Azure MFA を実装する

この演習の主な作業は次のとおりです。

1. 新しい Azure AD テナントを作成する。

1. Azure AD Premium v2 試用版をアクティブにする。

1. Azure AD のユーザーとグループを作成する。

1. Azure AD ユーザーに Azure AD Premium v2 のライセンスを割り当てる。

1. 不正アラート、信頼できる IP、アプリのパスワードなどの Azure MFA 設定を構成する。

1. MFA 設定を検証する。


#### 作業 1: 新しい Azure AD テナントを作成する

1. Azure ポータルから [**リソースの作成**] ブレードを開きます。

1. [**リソースの作成**] ブレードの、Azure Marketplace の検索ボックスに「**Azure Active Directory**」と入力します。

1. 検索結果から、[Azure Active Directory] ブレードを開き [**作成**] をクリックします。

1. [**ディレクトリの作成**] ブレードで、次のような設定の Azure AD テナントを作成します。

- 組織名 : **AdatumLab101-4b**

- 初期ドメイン名 : 文字と数字の組み合わせで構成される一意の名前

- 国/リージョン : **米国**

> **注** : 初期ドメイン名は控えておいてください。この演習の後半で使用します。


#### 作業 2 : Azure AD Premium v2 試用版をアクティブにする

1. 画面右上の "**ディレクトリ + サブスクリプション**" フィルターをクリックし、新規作成した Azure AD テナントをクリックします。

   > **注** : [**ディレクトリ + サブスクリプション**] フィルターは、Azure ポータルのツール バーの通知アイコンの左にあります。

   > **注** : [**ディレクトリ + サブスクリプション**] フィルターのリストに "**AdatumLab101-4b**" エントリがない場合は、ページを更新します。

1. Azure ポータルから、[Azure Active Directory] ブレードを開き、[**AdatumLab101-4b - 概要**] ブレードを表示します。

1. [AdatumLab101-4b] の [**概要**] ブレードから、[**ライセンス**] ブレードに移動します。

1. [ライセンス] の [**概要**] ブレードから、[**すべての製品**] ブレードに移動します。

1. [**ライセンス - すべての製品**] ブレードで、[**+ 試用/購入**] をクリックして、[**アクティブ化**] ブレードを開きます。そして、"**Azure AD PREMIUM P2**" の [**無料試用版**] を開き、[**アクティブ化**] をクリックします。


#### 作業 3 : Azure AD のユーザーとグループを作成する

1. Azure ポータルの [すべてのサービス] から「ユーザー」と検索し、Azure AD テナント AdatumLab101-4b の [**ユーザー - すべてのユーザー**] ブレードを開きます。

1. [**ユーザー - すべてのユーザー**] ブレードで、[+ 新しいユーザー] をクリックし、次のような設定で新しいユーザーを作成します。

   - 名前 : **aaduser1**

   - ユーザー名 : **aaduser1@&lt;DNS-domain-name&gt;.onmicrosoft.com** (&lt;DNS-domain-name&gt; には作業 1 で指定した、初期ドメイン名が入ります。)
   > **注** : このユーザー名を控えておいてください。この演習の後半で使用します。

   - パスワード : [**パスワードを表示**] のボックスにチェックを入て [**初期パスワード**] に表示される文字列を控えておきます。この演習の後半で使用します。

   - グループ : **0 個のグループが選択されました**

   - 役割 : **グローバル管理者**



1. [**ユーザー - すべてのユーザー**] ブレードで、[+ 新しいユーザー] をクリックし、次のような設定で新しいユーザーを作成します。

   - 名前 : **aaduser2**

   - ユーザー名 : **aaduser2@&lt;DNS-domain-name&gt;.onmicrosoft.com** (&lt;DNS-domain-name&gt; には作業 1 で指定した、初期ドメイン名が入ります。)
   > **注** : このユーザー名を控えておいてください。この演習の後半で使用します。

   - パスワード : [**パスワードを表示**] のボックスにチェックを入て [**初期パスワード**] に表示される文字列を控えておきます。この演習の後半で使用します。

   - グループ : **0 個のグループが選択されました**

   - 役割 : **ユーザー**




#### 作業 4 : Azure AD ユーザーに Azure AD Premium v2 のライセンスを割り当てる

> **注** : Azure AD ユーザーに Azure AD Premium v2 のライセンスを割り当てるためには、まずユーザーの場所属性を設定する必要があります。

1. [**ユーザー - すべてのユーザー**] ブレードから [aaduser1] をクリックして、[**aaduser1 - プロファイル**] ブレードを表示します。[設定] の [編集] をクリックして、[**利用場所**] を [**米国**] に設定し、[保存] をクリックします。

1. [aaduser1] の [**プロファイル**] ブレードから、[**ライセンス**] ブレードに移動します。[+ 割り当て] をクリックして、[製品] から "Azure Active Directory Premium P2" ライセンスを選択し、[保存] をクリックします。

1. [**ユーザー - すべてのユーザー**] ブレードに戻り、[**aaduser2 - プロファイル**] ブレードで、同じように [**利用場所**] を [**米国**] に設定します。

1. [aaduser2] の [**プロファイル**] ブレードから、[**ライセンス**] ブレードに移動します。[+ 割り当て] をクリックして、[製品] から "Azure Active Directory Premium P2" ライセンスを選択し、[保存] をクリックします。

1. [**ユーザー - すべてのユーザー**] ブレードで、演習用に使用しているユーザー アカウントをクリックし、プロファイルを表示します。同様に [**利用場所**] を [**米国**] に設定します。

1. ユーザー アカウントの [**ライセンス**] ブレードに移動します。[+ 割り当て] をクリックして、[製品] から "Azure Active Directory Premium P2" ライセンスを選択し、[保存] をクリックします。

1. 一度ポータルからサインアウトして、演習で使用しているアカウントで再度サインインします。

   > **注** : この手順は、ライセンス割り当てを有効にするために必須です。


#### 作業 5 : Azure MFA 設定を構成する

1. Azure ポータルの [すべてのサービス] から「ユーザー」と検索し、Azure AD テナント AdatumLab101-4b の [**ユーザー - すべてのユーザー**] ブレードを開きます。

1. Azure AD テナント AdatumLab101-4b の [**ユーザー - すべてのユーザー**] ブレードを表示します。[**Multi-Factor Authentication**] リンクをクリックして、[**多要素認証**] ポータルを開きます。

1. [**多要素認証**] ポータルで、[**サービス設定**] タブを開きます。設定を確認し、[**検証オプション**] で [**電話へのテキスト メッセージ**]、[**モバイル アプリによる通知**]、[**モバイル アプリまたはハードウェア トークンからの確認コード**] が有効になっていることを確認します。

1. [**多要素認証**] ポータルで、[**ユーザー**] タブに切り替えます。**aaduser1** エントリを選択し、"MULTI-FACTOR AUTHENTICATION の状態" を有効にします。

1. [**多要素認証**] ポータルで、**aaduser1** の "MULTI-FACTOR AUTHENTICATION の状態" が、"**有効**" になっていることを確認します。また、再度このユーザーを選択すると、状態を "**強制**" とするオプションが追加されていることが分かります。

   > **注** : ユーザーの状態を "有効" から "強制" に変更すると、レガシ、Azure MFA をサポートしない Azure AD 統合アプリにのみ影響があり、状態が "強制" に変わると、アプリ パスワードの使用が必要になります。

1. [**多要素認証**] ポータルで、[**aaduser1**] エントリが選択された状態で、[**ユーザー設定の管理**] ウィンドウを開きます。設定内に、次のオプションがあることを確認します。

   - 選択したユーザーについて連絡方法の再指定を必須にする

   - 選択したユーザーが生成したすべての既存のアプリケーション パスワードを削除する

   - 記憶されているすべてのデバイスに多要素認証を復元

1. 変更は加えず、Azure ポータルに戻ります。

1. Azure AD テナント AdatumLab101-4b の [**ユーザー - すべてのユーザー**] ブレードから、[**AdatumLab101-4b - 概要**] ブレードに移動します。

1. AdatumLab101-4b の [**概要**] ブレードから、[**MFA**] ブレードに移動します。

1. [**Multi-Factor Authentication - はじめに**] ブレードから、[**Multi-Factor Authentication - 不正アクセスのアラート**] に移動し、次のような設定を行います。

   - ユーザーが不正アクセスを通報できるようにする : **オン**

   - 不正を通報するユーザーを自動的にブロックする : **オン**

   - 案内メッセージ語に入力する不正アクセス通報コード : **0**


#### 作業 6 : MFA 設定を検証する

1. Microsoft Edge で InPrivate ウィンドウを開きます。

1. InPrivate ウィンドウで、**aaduser1** のアカウントで Azure ポータルにサインインします。プロンプトが表示された場合は、パスワードを新しく設定してください。

   > **注** : 前述したとおり、Azure AD テナント **aaduser1** ユーザー アカウントの DNS ユーザー名を含む、アカウントの正式なユーザー名を入力する必要があります。

1. "**詳細情報が必要**" というメッセージが表示された場合は、[次へ] をクリックして、[**追加のセキュリティ確認**] ページを開きます。

1. "**手順 1: ご希望のご連絡方法をお知らせください。**" セクションでは、次のうちいずれかのオプションで設定する必要があります。

   - **認証用電話**

   - **モバイルアプリ**

1. [**認証用電話**] オプションを選択し、[**テキスト メッセージでコードを送信する**] を有効にします。

1. 手順を続けていくと、確認コードが送信され、アプリ パスワードも自動的に生成されます。

1. プロンプトが表示される場合は、**aaduser1** アカウントに最初に設定されたパスワードから、別のパスワードに変更します。

1. Azure ポータルにサインインできたことを確認します。

1. **aaduser1** ユーザーとしてサインアウトして、InPrivateウィンドウを閉じます。


### 演習 2 : Azure AD Identity Protection を実装する

この演習の主な作業は次のとおりです。

1. Azure AD Identity Protection を有効にする

1. ユーザー リスク ポリシーを構成する

1. サインイン リスク ポリシーを構成する

1. リスク イベントをシミュレートして、Azure AD Identity Protection の構成を検証する


#### 作業 1 : Azure AD Identity Protection を有効にする

1. 演習用の仮想マシンで、Microsoft Edge を起動します。[**http://portal.azure.com**](http://portal.azure.com) から、Azure AD テナント **AdatumLab101-4b** テナントを作成するのに使用したアカウントでサインインします。

   > **注** : Azure AD テナント **AdatumLab101-4b** にサインインしていて、フィルターがかかっていることを確認します。Azure AD テナントのフィルターの切り替えは、[**ディレクトリ + サブスクリプション**] で行います。

1. Azure ポータルから [**リソースの作成**] ブレードを開きます。

1. [**リソースの作成**] ブレードの、Azure Marketplace の検索ボックスに「**Azure AD Identity Protection**」と入力します。

1. 検索結果から、[**Azure AD Identity Protection**] を選択し、[作成] をクリックします。Azure AD テナント **AdatumLab101-4b** に関連付ける **Azure AD Identity Protection** インスタンスを作成します。

1. Azure ポータルの [**すべてのサービス**] ブレードで、「**Azure AD Identity Protection**」と検索して、移動します。


#### 作業 2 : ユーザー リスク ポリシーを構成する

1. [**Azure AD Identity Protection**] ブレードで、[**Azure AD Identity Protection - ユーザー リスク ポリシー**] ブレードを開きます。

1. [**Azure AD Identity Protection - ユーザー リスク ポリシー**] ブレードで、**ユーザー リスク是正ポリシー** を次のように設定します。

   - 割り当て :

      - ユーザー : **すべてのユーザー** (テナントからロックアウトされないように、現在の管理者アカウントは [対象外] とします。)

      - 条件 :

         - ユーザーのリスク : **中以上**
   - コントロール :

      - アクセス : **アクセスを許可**

      - **パスワードの変更を必須とする**
   - ポリシーの適用 : **オン**




#### 作業 3 : サインイン リスク ポリシーを構成する

1. [**Azure AD Identity Protection - ユーザー リスク ポリシー**] ブレードから、[**Azure AD Identity Protection - サインイン リスク ポリシー**] に移動します。

1. [**Azure AD Identity Protection - サインイン リスク ポリシー**] ブレードで、**サインイン リスク是正ポリシー** を次のように設定します。

   - 割り当て :

      - ユーザー : **すべてのユーザー**

      - 条件 :

         - ユーザーのリスク : **中以上**
   - コントロール :

      - アクセス : **アクセスを許可**

      - **多要素認証を要求する**
   - ポリシーの適用 : **オン**




#### 作業 4 : リスク イベントをシミュレートして、Azure AD Identity Protection の構成を検証する

> **注** : この作業を開始する前に、演習 0 で開始したテンプレートの展開が完了していることを確認してください。

1. Azure ポータルの [**ディレクトリ + サブスクリプション**] フィルターで、既定の Azure AD テナントに切り替えます。

1. Azure ポータルから、[**az1010401b-vm1**] ブレードを開きます。

1. [**az1010401b-vm1**] ブレードで、[接続] をクリックし、RDP プロトコル経由で Azure 仮想マシンに接続するようにします。サインインが必要な場合は、次の資格情報を入力します。

   - Admin Username : **Student**

   - Admin Password : **Pa55w.rd1234**

1. Remote Desktop セッションで、Server Manager の [**Local Server**] をクリックし、[**IE Enhanced Security Configuration**] をクリックします。

1. [**Internet Explorer Enhanced Security Configuration**] ダイアログ ボックスで、両方を [**Off**] にして [**OK**] をクリックします。

1. リモート デスクトップ セッションで、Internet Explorer のInPrivateウィンドウを開きます。

1. 開いたウィンドウで、[**https://www.torproject.org/projects/torbrowser.html.en**](https://www.torproject.org/projects/torbrowser.html.en) から "ToR Browser Project" にアクセスし、Tor Browser をダウンロードして、既定のオプションでインストールします。

1. Tor Browser のインストールが完了したら、最初のページで [**Connect**] オプションを使用し、[**https://myapps.microsoft.com**](https://myapps.microsoft.com) からApplication Access Panel にアクセスします。

1. プロンプトが表示されたら、**aaduser2** アカウントでサインインします。

1. "**Your sign-in was blocked**" というメッセージが表示されます。これは、予想された結果です。Tor Browser 使用に伴いサインイン リスクが増加しているため、多要素認証が必須となりますが、このアカウントは多要素認証を設定していないためブロックされます。

1. **Sign out and sign in with a different account option** から、**aaduser1** アカウントでサインインします。

1. 今回は、"**Suspicious activity detected**" というメッセージが表示されます。これも、予想された結果です。このアカウントは、多要素認証を設定されているためです。Tor Browser 使用に伴いサインイン リスクが増加しているため、多要素認証が必須となりますが、前の作業でこのアカウントのサインイン リスクポリシーを設定していることによる結果です。

1. [**Verify**] オプションを使用し、認証をテキスト メッセージ経由で行うか、電話にて行うかを選択します。

1. 検証が完了したら、Application Access Panel に正常にサインインできたことを確認します。

1. **aaduser1** としてサインアウトして、Tor Browser ウィンドウを閉じます。

1. Internet Explorer を起動し、[**http://portal.azure.com**](http://portal.azure.com) から Azure ポータルを開きます。Azure AD テナント **AdatumLab101-4b** を作成するのに使用した Microsoft アカウントでサインインします。

1. [リスク検出 (リスク イベント)] をクリックし、[**Azure AD Identity Protection - リスクの検出 (リスク イベント)**] ブレードを開きます。[**匿名の IP アドレスからのサインイン**] にエントリがあることが確認できます。

1. [**Azure AD Identity Protection - リスクの検出 (リスク イベント)**] ブレードから、[危険なユーザー (リスクのフラグ付きユーザー)] をクリックし、[**Azure AD Identity Protection - 危険なユーザー (リスクのフラグ付きユーザー)**] ブレードに移動し、"**aaduser2**" というエントリがあることが確認できます。

> **結果** : この演習では、Azure AD Identity Protection を有効にし、ユーザー リスク ポリシーとサインイン リスク ポリシーを構成し、さらにリスク イベントをシミュレートして Azure AD Identity Protection の構成を検証しました。

## 演習 3 : 演習用リソースを削除する

#### 作業 1 : Cloud Shell を開く

1. Azure ポータルの上部にある **Cloud Shell** アイコンをクリックして、Cloud Shell ペインを開きます。

1. Cloud Shell インターフェイスで [**Bash**] を選択します。

1. **Cloud Shell** のコマンド プロンプトで、次のコマンドを入力し [**Enter**] を押します。これにより、この演習で作成したすべてのリソース グループが表示されます。

   ```sh
   az group list --query "[?starts_with(name,'az1010')].name" --output tsv
   ```

1. 出力結果を確認し、リストにはこの演習で作成したリソース グループのみが含まれることを確認します。これらのリソース グループを、次の作業で削除します。

#### 作業 2 : リソース グループを削除する

1. **Cloud Shell** のコマンド プロンプトで、次のコマンドを入力し [**Enter**] を押します。これにより、この演習で作成したリソース グループを削除できます。

   ```sh
   az group list --query "[?starts_with(name,'az1010')].name" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
   ```

1. ポータルの下部に表示される **Cloud Shell** プロンプトを閉じます。

> **注** : この演習で作成したテナントをすべて削除する場合は、次のページを参照してください。 https://docs.microsoft.com/en-us/azure/active-directory/users-groups-roles/directory-delete-howto

> **結果** : この演習では、演習内で使用したリソースをすべて削除しました。
