---
lab:
    title: 'Role-Based Access Control'
    module: 'Module 11 - Governance and Compliance'
---

# 演習 : ロールベースのアクセス制御

この演習のすべての作業には、Azure ポータル (PowerShell クラウド シェル セッションを含む) を使用します。

> **注** : クラウド シェルを使用しない場合は、Azure PowerShell 1.2.0 (またはそれ以降の) モジュールをインストールした演習用仮想マシンが必要となります。 [https://docs.microsoft.com/en-us/powershell/azure/install-az-ps](https://docs.microsoft.com/en-us/powershell/azure/install-az-ps)

演習用ファイル : なし

### シナリオ

Adatum Corporation は、Azure ロール ベースのアクセス制御と Azure ポリシーを使用して、Azure リソースのプロビジョニングと管理を制御したいと考えています。また、プロビジョニングと管理のタスクを自動化して追跡できるようにしたいと考えています。

### 目的

この演習を修了すると、次のことができるようになります。

- 組み込みのロールベースのアクセス制御 (RBAC) のロールと組み込みの Azure Policyを使用した、Azure リソースのプロビジョニングと管理の委任を構成する。

- DNSAzure リソースを代理管理者としてプロビジョニングし、プロビジョニング イベントを監査して、委任を確認する。


### 演習 1 : 組み込みのロールベースのアクセス制御 (RBAC) のロールと組み込みの Azure Policyを使用した、Azure リソースのプロビジョニングと管理の委任を構成する

この演習の主な作業は次のとおりです。

1. Azure Active Directory (AD) ユーザーとグループを作成する。

1. Azure リソース グループを作成する。

1. 組み込みの RBAC ロールを介して Azure リソースグループの管理を委任する。

1. Azure リソース グループに組み込みの Azure Policyを割り当てる。


#### 作業 1 : Azure Active Directory (AD) ユーザーとグループを作成する

1. 演習用の仮想マシンで、Microsoft Edge を起動します。[**http://portal.azure.com**](http://portal.azure.com) から Azure ポータル にアクセスします。演習用の Azure サブスクリプションのうち、所有者役割と Azure AD テナントのグローバル管理者の役割を持つ Microsoft アカウントでサインインします。

1. Azure ポータルで、[**Azure Active Directory**] ブレードを開きます。

1. [**Azure Active Directory**] ブレードの [**カスタム ドメイン名**] ブレードを開き、Azure AD テナントに関連付けられた初期 DNS ドメイン名を確認します。このドメイン名を控えておいてください。この作業の後半で使用します。

1. Azure AD の [**カスタム ドメイン名**] ブレードから、[**ユーザー**] ブレードに移動します。

1. [**ユーザー - すべてのユーザー**] ブレードで、[+ 新しいユーザー] をクリックし、次のような設定で新しいユーザーを作成します。

   - 名前 : **aaduser100011**

   - ユーザー名 : **aaduser100011@&lt;DNS-domain-name&gt;** &lt;DNS-domain-name&gt; には、この作業の前半で確認した初期 DNS ドメイン名を指定します。

   - パスワード : [**パスワードを表示**] のボックスにチェックを入て [**初期パスワード**] に表示される文字列を控えておきます。この演習の後半で使用します。

   - グループ : **0 個のグループが選択されました**

   - 役割 : **ユーザー**

1. [**ユーザー - すべてのユーザー**] ブレードから、[**グループ**] ブレードに移動します。

1. [**グループ - すべてのグループ**] ブレードで、[+ 新しいグループ] をクリックして、次のような設定のグループを作成します。

   - グループの種類 : **セキュリティ**

   - グループ名 : **az1001 Contributors**

   - グループの説明 : **az1001 Contributors**

   - メンバーシップの種類 : **割り当て済み**

   - メンバー : **aaduser100011**


#### 作業 2 : Azure リソース グループを作成する

1. Azure ポータルから [**リソース グループ**] ブレードを開きます。

1. [**リソース グループ**] ブレードで、[+ 追加] をクリックして、次のような設定のリソース グループを作成します。

   - リソース グループ名 : **az1000101-RG**

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リージョン : 演習環境に最も近い Azure リージョンの中で、Azure 仮想マシンをプロビジョ二ングできる場所を選択します。
   > **注** : Azure 仮想マシンをプロビジョニングできる Azure リージョンを確認するには、こちらを参照してください。 [**https://azure.microsoft.com/en-us/regions/offers/**](https://azure.microsoft.com/en-us/regions/offers/)

1. [**Resource groups**] で、[+ 追加] をクリックして、次のような設定の 2 つ目のリソース グループを作成します。

   - リソース グループ名 : **az1000102-RG**

   - サブスクリプション : 前の手順で選択したサブスクリプション

   - リージョン : 前の手順で選択した Azure リージョン


#### 作業 3 : 組み込みの RBAC ロールを介して Azure リソースグループの管理を委任する

1. Azure ポータルの [**リソース グループ**] ブレードを開き、[**az1000101-RG**] を選択します。

1. [**az1000101-RG**] ブレードの、[**アクセス制御 (IAM)**] ブレードを開きます。

1. [**az1000101-RG - アクセス制御 (IAM)**] ブレードの、[**ロールの割り当て**] ブレードを表示します。

1. [**ロールの割り当て**] ブレードで、[+ 追加] をクリックして、次のような**ロールの割り当て**を作成します。

   - 役割 : **共同作成者**

   - アクセスの割り当て先 : **Azure AD のユーザー、グループ、サービス プリンシパル**

   - 選択 : **az1001 Contributors**


#### 作業 4 : Azure リソース グループに組み込みの Azure Policyを割り当てる

1. [**az1000101-RG**] ブレードの [**ポリシー**] ブレードを開きます。

1. [**ポリシー - コンプライアンス**] ブレードで、[**ポリシーの割り当て**] をクリックします。

1. 次のようにポリシーを割り当てます。

   - スコープ : **az1000101-RG**

   - 除外 : 空白

   - ポリシー定義 : [...] から、ポリシー定義ピッカーを起動して "**許可されている仮想マシン SKU**" を選択します。

   - 割り当て名 : **許可されている仮想マシン SKU**

   - 許可されている仮想マシン SKU説明 : **許可されている仮想マシン SKU (Standard_DS1_v2)**

   - 割り当て担当者 : 既定値のまま

   - 許可されている SKU : **Standard_DS1_v2**

   - マネージド ID を作成します : チェックは付けずに空白のまま

> **結果**: この演習では、Azure AD ユーザーと Azure AD グループを作成し、2 つの Azure リソース グループを作成しました。最初の Azure リソース グループの管理を、組み込みの仮想マシン共同作成者 RBAC ロールを介して委任しました。また、同じリソース グループに、Azure 仮想マシンに使用できる SKU を制限する組み込み Azure Policy も割り当てました。


### 演習 2 : Azure リソースを代理管理者としてプロビジョニングし、プロビジョニング イベントを監査して、委任を確認する

この演習の主な作業は次のとおりです。

1. Azure 仮想マシンの展開に使用できる DNS 名を指定する。

1. ポリシーに準拠していない Azure 仮想マシンの委任管理者としての自動展開を試みる。

1. 代理管理者として、ポリシーに準拠した Azure 仮想マシンの自動展開を実行する。

1. Azure 仮想マシンの展開に対応する Azure アクティビティ ログ イベントを確認する。


#### 作業 1 : Azure 仮想マシンの展開に使用できる DNS 名を指定する

1. Azure ポータル の Cloud Shell ペインから、PowerShell セッションを開始します。

   > **注** : 現在の Azure サブスクリプションで Cloud Shell を初めて起動する場合、Cloud Shell ファイルを維持するための Azure ファイル共有の作成を要求されます。既定のまま設定すると、自動生成されたリソース グループにストレージ アカウントが作成されます。

1. Cloud Shell ペインで、次のコマンドを実行します。&lt;custom-label&gt; プレースホルダーには、一意の文字列を代入し、&lt;location-of-az1000101-RG&gt; プレースホルダーには、リソース グループ **az1000101-RG** を作成した Azure リージョンを代入します。

   ```pwsh
   Test-AzDnsAvailability -DomainNameLabel <custom-label> -Location '<location-of-az1000101-RG>'
   ```

1. コマンドが検証され "**True**" が返されます。"**True**" が返されるまで、&lt;custom-label&gt; の値を変えながら、同じコマンドを実行してください。

1. 成功した &lt;custom-label&gt; の値を控えておいてください。次の作業で使用します。

1. 次のコマンドを実行します。

   ```pwsh
   Register-AzResourceProvider –ProviderNamespace Microsoft.Network
   ```

   ```pwsh
   Register-AzResourceProvider –ProviderNamespace Microsoft.Compute
   ```
   > **注** : これらのコマンドを実行することにより、Azure Resource Manager Microsoft.Network と Microsoft.Compute resource providers を登録することができます。これは、Azure Resource Manager テンプレートを使用して、これらのリソース プロバイダーによって管理するリソースを展開するときに、(サブスクリプションごとに) 1 回限り必要な操作です (これらのリソース プロバイダーが未登録の場合)。

   > **注** :  これらのコマンドを実行して、現在の時刻より前の時刻に設定されたトークンの有効期限について言及するエラーが発生した場合は、Cloud Shell UI を一旦閉じて、Cloud Shell インスタンスを再起動します。再起動したら、コマンドを再度実行します。

#### 作業 2 : ポリシーに準拠していない Azure 仮想マシンの委任管理者としての自動展開を試みる

1. Edge で InPrivate ウィンドウを起動します。

1. InPrivate ウィンドウで、Azure ポータルにアクセスして、演習 1 で作成したユーザー アカウントでサインインします。プロンプトが表示された場合は、パスワードを新しく設定してください。

1. Azure ポータルの [**リソース グループ**] ブレードを開き、**az1000101-RG** のみが表示されていることを確認します。

1. Azure ポータルから [**リソースの作成**] ブレードを開きます。

1. [**リソースの作成**] ブレードの、Azure Marketplace の検索ボックスに「**Template deployment**」と入力します。

1. 検索結果から [**テンプレートのデプロイ**] ブレードを開き、[作成] をクリックします。

1. [**カスタム デプロイ**] ブレードで、[**GitHub クイックスタート テンプレートを読み込む**] のドロップダウン リストから、[**101-vm-simple-linux**] エントリを選択して、[**テンプレートの編集**] をクリックします。

1. [**テンプレートの編集**] ブレードの [**変数**] セクションで、"**vmSize**" を指定しているエントリを確認します。

1. テンプレートでは、"**Standard_A1**" という VM size にハードコーディングされています。

1. テンプレートに変更を加えてしまった可能性があるため [破棄] をクリックして、[**Deploy a simple Ubuntu Linux VM**] ブレードに移動します。

1. [**Deploy a simple Ubuntu Linux VM**] ブレードで、次のように設定し、[購入] をクリックします。

   - サブスクリプション : 演習 1 で選択したサブスクリプション

   - リソース グループ : **az1000101-RG**

   - 場所 : 演習 1 で選択した Azure リージョン

   - Admin Username : **Student**

   - Authentication Type : **password**

   - Admin Password : **Pa55w.rd1234**

   - Dns Label Prefix : 前の作業で指定した &lt;custom-label&gt;

   - Ubuntu OS Version : 既定値のまま

   - Location : 既定値のまま

1. 検証エラーが発生します。**エラー** の詳細を確認するリンクをクリックし、"**許可されている仮想マシン SKU**" というポリシーにより、リソースの展開が許可されなかったことを確認します。


#### 作業 3 : 代理管理者として、ポリシーに準拠した Azure 仮想マシンの自動展開を実行する

1. [**Deploy a simple Ubuntu Linux VM**] ブレードに戻り、[**テンプレートの編集**] をクリックします。

1. [**Edit template**] ブレードで、"**変数**" セクションの "**vmSize**" エントリを確認します。

1. このエントリの "**Standard_A1**" という部分を "**Standard_DS1_v2**" に変更し、[保存] します。

1. 再度、展開します。今回は、検証の結果エラーは表示されません。

1. 展開が完了するのを待つ必要はありません。次の作業に進んでください。


#### 作業 4 : Azure 仮想マシンの展開に対応する Azure アクティビティ ログ イベントを確認する

1. 演習 1 で使用していたブラウザに戻ります。

1. Azure ポータルから、リソース グループ [**az1000101-RG**] ブレードを開きます。

1. [**az1000101-RG**] ブレードの [**アクティビティ ログ**] ブレードを開きます。

1. 操作リストの中で、検証に失敗したエントリと、成功したエントリがあることを確認します。

1. ページの情報を更新し、Azure 仮想マシンのプロビジョニングに関連するイベントを確認します。最後の展開が成功していることが表示されます。

> **結果**: この演習では、Azure 仮想マシンの展開に使用できる DNS 名を特定しました。また、代理管理者としてポリシーに準拠していないAzure 仮想マシンの自動展開を試み、ポリシーに準拠したAzure 仮想マシンの自動展開も実行しました。そして、両方の Azure 仮想マシンの展開に対応する Azure アクティビティ ログ エントリを確認しました。

## 演習 3 : 演習用リソースを削除する

#### 作業 1 : Cloud Shell を開く

1. Azure ポータルの上部にある **Cloud Shell** アイコンをクリックして、Cloud Shell ペインを開きます。

1. Cloud Shell インターフェイスで [**Bash**] を選択します。

1. **Cloud Shell** のコマンド プロンプトで、次のコマンドを入力し [**Enter**] を押します。これにより、この演習で作成したすべてのリソース グループが表示されます。

   ```sh
   az group list --query "[?starts_with(name,'az1000')].name" --output tsv
   ```

1. 出力結果を確認し、リストにはこの演習で作成したリソース グループのみが含まれることを確認します。これらのリソース グループを、次の作業で削除します。

#### 作業 2 : リソース グループを削除する

1. **Cloud Shell** のコマンド プロンプトで、次のコマンドを入力し [**Enter**] を押します。これにより、この演習で作成したリソース グループを削除できます。

   ```sh
   az group list --query "[?starts_with(name,'az1000')].name" --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
   ```

1. ポータルの下部に表示される **Cloud Shell** プロンプトを閉じます。

> **結果** : この演習では、演習内で使用したリソースをすべて削除しました。
