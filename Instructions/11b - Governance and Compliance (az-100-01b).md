---
lab:
    title: 'Governance and Compliance'
    module: 'Module 11 - Governance and Compliance'
---

# 演習 : ガバナンスとコンプライアンス

この演習のすべての作業には、Azure ポータル (PowerShell クラウド シェル セッションを含む) を使用します。

> **注** : クラウド シェルを使用しない場合は、Azure PowerShell 1.2.0 (またはそれ以降の) モジュールをインストールした演習用仮想マシンが必要となります。 [https://docs.microsoft.com/en-us/powershell/azure/install-az-ps](https://docs.microsoft.com/en-us/powershell/azure/install-az-ps)

演習用ファイル :

- **Labfiles\\Module_11\\Governance_and_Compliance\\AZ-100.1/az-100-01b_azuredeploy.json**

- **Labfiles\\Module_11\\Governance_and_Compliance\\az-100-01b_azuredeploy.parameters.json**

### シナリオ

Adatum Corporationは、Azure サブスクリプションでリソースのタグ付けを強制するために Azure のポリシーとイニシアティブを使用したいと考えています。環境が準拠したら、Adatum はリソース ロックを実装し意図しない変更を防ぎたいと考えています。

### 目的

この演習を修了すると、次のことができるようになります。

- Azure のポリシーとイニシアティブを使用して Azure タグを実装する。

- Azure リソース ロックを実装する。


### 演習 1 : Azure のポリシーとイニシアティブを使用して Azure タグを実装する

この演習の主な作業は次のとおりです。

1. Azure Resource Manager テンプレートを使用して Azure リソースをプロビジョニングする。

1. リソースのタグ付けコンプライアンスを評価するイニシアティブとポリシーを実装する。

1. リソースのタグ付けコンプライアンスを強化するポリシーを実装する。

1. タグ付けの強制とタグ付けのコンプライアンスを評価する。

1. リソースのタグ付けの違反を修復する。

1. コンプライアンス タスクに対する修復タスクの効果を評価する。


#### 作業 1 : Azure Resource Manager テンプレートを使用して Azure リソースをプロビジョニングする

1. 演習用の仮想マシンで、Microsoft Edge を起動します。[**http://portal.azure.com**](http://portal.azure.com) から Azure ポータル にアクセスします。演習用の Azure サブスクリプションの所有者ロールをもつ Microsoft アカウントでサインインします。

1. Azure ポータルから [**リソースの作成**] ブレードを開きます。

1. [**リソースの作成**] ブレードの、Azure Marketplace の検索ボックスに「**Template deployment**」と入力します。

1. 検索結果から [**テンプレートのデプロイ**] ブレードを開き、[作成] をクリックします。

1. [**カスタム デプロイ**] ブレードで、[**エディターで独自のテンプレートを作成する**] をクリックします。

1. [**テンプレートの編集**] ブレードで、テンプレート ファイルを読み込みます。**az-100-01b_azuredeploy.json**.

   > **注** : テンプレートの内容を確認してください。ここでは、Windows Server 2016 Datacenter をホストする、リソースへのタグを含む Azure 仮想マシンの展開を定義しています。

1. このテンプレートを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードから、[**パラメーターの編集**] ブレードを開きます。

1. [**パラメーターの編集**] ブレードで、パラメーター ファイルを読み込みます。**az-100-01b_azuredeploy.parameters.json**.

1. パラメーターを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードで、次の設定で展開を開始します。

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リソース グループ :「**az1000101b-RG**」という名前のリソース グループを新規作成します。

   - 場所 : 演習環境に最も近い Azure リージョンの中で、Azure 仮想マシンをプロビジョ二ングできる場所を選択します。

   - Vm Size : **Standard_DS1_v2**

   - Vm Name : **az1000101b-vm1**

   - Admin Username : **Student**

   - Admin Password : **Pa55w.rd1234**

   - Virtual Network Name : **az1000101b-vnet1**

   - Environment Name : **lab**
   > **注** : Azure 仮想マシンをプロビジョニングできる Azure リージョンを確認するには、こちらを参照してください。[**https://azure.microsoft.com/en-us/regions/offers/**](https://azure.microsoft.com/en-us/regions/offers/)

   > **注** : 展開が完了するのを待つ必要はありません。次の作業に進んでください。

1. Azure ポータルの [すべてのサービス] から、[**タグ**] ブレードを検索します。

1. [**タグ**] ブレードで、[**environment : lab**] をクリックして、**"environment : lab"** と値が設定されているリソースをすべて表示します。前の作業で展開しているリソースのうち、このタグが割り当てられているもののいくつかが表示されています。

   > **注** : この時点では、すべてのリソースはプロビジョニングされていませんが、最低限数個のリソースはタグが割り当てられていなくても表示されているはずです。


#### 作業 2 : リソースのタグ付けコンプライアンスを評価するイニシアティブとポリシーを実装する

1. Azureポータルで、[すべてのサービス] から [**ポリシー**] ブレードを検索します。

1. [**ポリシー**] ブレードの、[**定義**] ブレードを開きます。

1. [**ポリシー - 定義**] ブレードから、[**タグとその値が必要**] というポリシー定義を表示します。

1. [**タグとその値が必要**] ブレードで、[定義を複製する] をクリックして、次のような設定の新しいポリシーを作成します。

   - 定義の場所 : この演習で使用しているサブスクリプション

   - 名前 : **az10001b - Audit tag and its value**

   - 説明 : **必要なタグとその値を監査します。リソースグループには適用されません。**

   - カテゴリ : 「**Lab**」という名前のカテゴリーを新規作成します。

   - ポリシー ルール : 複製したルールの "**effect**" を "**deny**" から "**audit**" に変更します。ルールは次のとおり記述されています。
   ```json
   {
    "mode": "indexed",
    "policyRule": {
      "if": {
       "not": {
         "field": "[concat('tags[', parameters('tagName'), ']')]",
         "equals": "[parameters('tagValue')]"
       }
   },
    "then": {
      "effect": "audit"
    }
   },
    "parameters": {
     "tagName": {
       "type": "String",
       "metadata": {
        "displayName": "タグ名",
        "description": "タグの名前 (例: environment)"
      }
    },
    "tagValue": {
      "type": "String",
      "metadata": {
        "displayName": "タグ値",
        "description": "タグの値 (例: production)"
       }
      }
     }
    }
   ```

1. [**ポリシー - 定義**] ブレードで、[+ イニシアティブ定義] をクリックして、[**イニシアティブ定義**] ブレードを開きます。

1. [**イニシアティブ定義**] ブレードで、次のような設定のイニシアティブ定義を作成します。

   - 定義の場所 : この演習で使用しているサブスクリプション

   - 名前 : **az10001b - Tagging initiative**

   - 説明 : **タグ ポリシーのコレクション。**

   - カテゴリ : **Lab**

   - 使用可能な定義 : 先ほど作成した **az10001b - Audit tag and its value** ポリシー定義を選択します。

      - タグ名 : **environment**

      - タグ値 : **lab**

1. [**ポリシー - 割り当て**] ブレードに移動します。

1. [**ポリシー - 割り当て**] ブレードで、[**イニシアティブの割り当て**] をクリックして、次のような設定でイニシアティブの割り当てを作成します。

   - スコープ : この演習で使用しているサブスクリプション名

   - 除外 : なし

   - イニシアティブ定義 : **az10001b - Tagging initiative**

   - 割り当て名 : **az10001b - Tagging initiative assignment**

   - 説明 : **Assignment of az10001b - Tagging initiative**

   - 割り当て担当者 : 既定値のまま

   - マネージド ID : **チェックしない**

1. [**ポリシー - コンプライアンス**] ブレードに移動します。[**コンプライアンスの状態**] が "**未登録**" または "**未開始**" となっていることを確認します。

   > **注** : コンプライアンス スキャンが開始されるまでには、平均で約 10 分かかります。コンプライアンス スキャンを待たず、次の作業に進みます。演習の後半で、コンプライアンスの状態を再度確認します。


#### 作業 3 : リソースのタグ付けコンプライアンスを強化するポリシーを実装する

1. [**ポリシー - 定義**] ブレードを開きます。

1. [**ポリシー - 定義**] ブレードから、[**az10001b - Tagging initiative**] を検索して、表示します。

1. [**az10001b - Tagging initiative**] ブレードで、[**イニシアティブの編集**] をクリックします。

1. 使用可能な定義から、[**タグとその値が必要**] というビルトインのポリシー定義を追加し、パラメーターを次のように設定します。

   - タグ名 : **environment**

   - タグ値 : **lab**
   > **注** : この時点で、イニシアティブには 2 つのポリシーが含まれています。最初のポリシーは、コンプライアンスの状態を評価して、2 つ目のポリシーは展開中のタグ付けを強制します。


#### 作業 4 : タグ付けの強制とタグ付けのコンプライアンスを評価する

1. Azure ポータルから [**リソースの作成**] ブレードを開きます。

1. [**リソースの作成**] ブレードの、Azure Marketplace の検索ボックスに「**Template deployment**」と入力します。

1. 検索結果から [**テンプレートのデプロイ**] ブレードを開き、[作成] をクリックします。

1. [**カスタム デプロイ**] ブレードで、[**エディターで独自のテンプレートを作成する**] をクリックします。

1. [**テンプレートの編集**] ブレードで、テンプレート ファイルを読み込みます。**az-100-01b_azuredeploy.json**.

   > **注** : これは、作業 1 で展開したテンプレートと同様です。

1. このテンプレートを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードから、[**パラメーターの編集**] ブレードを開きます。

1. [**パラメーターの編集**] ブレードで、パラメーター ファイルを読み込みます。**az-100-01b_azuredeploy.parameters.json**.

1. パラメーターを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードで、次の設定で展開を開始します。

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リソース グループ : 「**az1000102b-RG**」という名前のリソース グループを新規作成します。

   - 場所 : 作業 1 で指定した Azure リージョン

   - Vm Size : **Standard_DS1_v2**

   - Vm Name : **az1000102b-vm1**

   - Admin Username : **Student**

   - Admin Password : **Pa55w.rd1234**

   - Virtual Network Name : **az1000102b-vnet1**

   - Environment Name : **lab**
   > **注** : 展開は失敗します。これは予想された結果です。

1. 検証エラーが発生したというメッセージが表示されます。エラーの詳細を確認し、**az10001b - Tagging initiative assignment** に含まれている "**Require tag and its value**" というポリシーにより、**az1000102b-vnet1** の展開が許可されなかったということが記述されています。

1. [**ポリシー - コンプライアンス**] ブレードに移動します。[**コンプライアンスの状態**] 列のエントリを確認します。

1. [**az10001b - Tagging initiative assignment**] をクリックして、コンプライアンスの状態のサマリーを確認します。

1. 表示されたリソースの一覧で、コンプライアンスの状態が "準拠していない" となっていることを確認します。

   > **注** : [**ポリシー - コンプライアンス**] ブレードで、[**最新の方法に更新**] ボタンをクリックして、コンプライアンスの状態を更新します。


#### 作業 5 : リソースのタグ付けの違反を修復する。

1. Azure ポータルで、[**az10001b - Tagging initiative**] ブレードを開きます。

1. [**az10001b - Tagging initiative**] ブレードで、[**イニシアティブの編集**] をクリックします。

1. [**タグとその既定値の追加**] というビルトインのポリシー定義を追加し、次のようにパラメーターの値を設定します。

   - タグ名 : **environment**

   - タグ値 : **lab**

1. "**az10001b - Audit tag and its value**" というカスタムのポリシー定義をイニシアティブから削除します。

1. "**タグとその値が必要**" というビルトインのポリシー定義もイニシアティブから削除します。

   > **注** : この時点では、イニシアティブには、新しいリソースの展開中にタグの違反を自動的に修正し、コンプライアンスの状態を評価する単一のポリシーのみが含まれています。

1. Azure ポータル の Cloud Shell ペインから、PowerShell セッションを開始します。

   > **注** : 現在の Azure サブスクリプションで Cloud Shell を初めて起動する場合、Cloud Shell ファイルを維持するための Azure ファイル共有の作成を要求されます。既定のまま設定すると、自動生成されたリソース グループにストレージ アカウントが作成されます。

1. Cloud Shell ペインで、次のコマンドを実行します。

   ```pwsh
   Get-AzResource -ResourceGroupName 'az1000101b-RG' | ForEach-Object {Set-AzResource -ResourceId $_.ResourceId -Tag @{environment="lab"} -Force }
   ```

   > **注** : このコマンドを実行することで、リソース グループ "**az1000101b-RG**" 内のすべてのリソースに **environment** というタグと、その値として **lab** という値が設定され、既に割り当てられたタグは上書きされます。

   > **注** : コマンドが完了するまで待ちます。

1. Azure ポータルの [すべてのサービス] から、[**タグ**] ブレードを検索します。

1. [**タグ**] ブレードで、[**environment : lab**] をクリックして、**"environment : lab"** と値が設定されているリソースをすべて表示します。リソース グループ **az1000101b-RG** のリソースがすべて表示されていることを確認します。


#### 作業 6 : コンプライアンス タスクに対する修復タスクの効果を評価する

1. Azure ポータルから [**リソースの作成**] ブレードを開きます。

1. [**リソースの作成**] ブレードの、Azure Marketplace の検索ボックスに「**Template deployment**」と入力します。

1. 検索結果から [**テンプレートのデプロイ**] ブレードを開き、[作成] をクリックします。

1. [**カスタム デプロイ**] ブレードで、[**エディターで独自のテンプレートを作成する**] をクリックします。

1. [**テンプレートの編集**] ブレードで、テンプレート ファイルを読み込みます。**az-100-01b_azuredeploy.json**.

   > **注** : これは、作業 1 で展開したテンプレートと同様です。

1. このテンプレートを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードから、[**パラメーターの編集**] ブレードを開きます。

1. [**パラメーターの編集**] ブレードで、パラメーター ファイルを読み込みます。**az-100-01b_azuredeploy.parameters.json**.

1. パラメーターを保存し、[**カスタム デプロイ**] ブレードに戻ります。

1. [**カスタム デプロイ**] ブレードで、次の設定で展開を開始します。

   - サブスクリプション : この演習で使用しているサブスクリプション名

   - リソース グループ : **az1000102b-RG**

   - 場所 : 作業 1 で指定した Azure リージョン

   - Vm Size : **Standard_DS1_v2**

   - Vm Name : **az1000102b-vm1**

   - Admin Username : **Student**

   - Admin Password : **Pa55w.rd1234**

   - Virtual Network Name : **az1000102b-vnet1**

   - Environment Name : **lab**
   > **注** : 今回の展開は成功です。これは予想された結果です。

   > **注** : 展開が完了するのを待つ必要はありません。次の作業に進んでください。

1. Azure ポータルの [すべてのサービス] から、[**タグ**] ブレードを検索します。

1. [**タグ**] ブレードで、[**environment : lab**] をクリックして、**"environment : lab"** と値が設定されているリソースをすべて表示します。リソース グループ **az1000102b-RG** のリソースで、このタグと値を自動的に割り当てられているものが表示されています。

   > **注** : この時点では、すべてのリソースはプロビジョニングされていませんが、表示されているすべてのリソースに、自動的にタグが割り当てられています。

1. [**ポリシー - コンプライアンス**] ブレードに移動します。[**コンプライアンスの状態**] 列のエントリを確認します。

1. [**az10001b - Tagging initiative assignment**] を開きます。[**コンプライアンスの状態**] 列のエントリを確認します。列に "**未開始**" というエントリがある場合は、コンプライアンス スキャンが始まるまで待ちます。

   > **注** : コンプライアンスの状態が変化するまで、最大 10 分程度待つ場合があります。少し時間をおいてから、[**ポリシー - コンプライアンス**] ブレードの [**最新の情報に更新**] ボタンをクリックします。

   > **注** : コンプライアンスの状態が "準拠している" になるのを待つ必要はありません。次の作業に進んでください。

> **結果** : この演習では、リソースのタグ付けコンプライアンスを評価し、強制し、修復するイニシアティブとポリシーを実装しました。また、ポリシー割り当ての効果も評価しました。


### 演習 2 : Azure リソース ロックを実装する

この演習の主な作業は次のとおりです。

1. 偶発的な変更を防ぐために、リソース グループ レベルのロックを作成する。

1. リソース グループ レベルのロックの機能を検証する。


#### 作業 1 : 偶発的な変更を防ぐために、リソース グループ レベルのロックを作成する

1. Azure ポータルから、リソース グループ [**az1000101b-RG**] ブレードを開きます。

1. [**az1000101b-RG**] ブレードの [**ロック**] ブレードを表示します。

1. [**az1000101b-RG - Locks**] ブレードで、[+ 追加] をクリックして、次のような設定のロックを作成します。

   - ロック名 : **az1000101b-roLock**

   - ロックの種類 : **読み取り専用**


#### 作業 2 : リソース グループ レベルのロックの機能を検証する

1. Azure ポータルから、仮想マシン [**az1000102b-vm1**] ブレードを開きます。

1. [**az1000102b-vm1**] ブレードの [**タグ**] ブレードを表示します。

1. "**environment**" タグの値を "**dev**" に設定してみます。この操作は成功します。

1. Azure ポータルから、仮想マシン [**az1000101b-vm1**] ブレードを開きます。

1. [**az1000101b-vm1**] ブレードの、[**タグ**] ブレードを表示します。

1. "**environment**" タグの値を "**dev**" に設定してみます。この操作は失敗します。エラーとして、"リソース拒否タグの割り当て (ロックされている可能性があります)。" というメッセージが表示されています。

1. リソース グループ [**az1000101b-RG**] に作成されたストレージ アカウントを開きます。

1. そのストレージ アカウント ブレードの、[**アクセス キー**] ブレードを開きます。エラーとして、"リソースまたはその親の読み取りロックが原因でデータ プレーンにアクセスできません。" というメッセージが表示されます。

1. Azure ポータルから、リソース グループ [**az1000101b-RG**] ブレードを開きます。

1. [**az1000101b-RG**] ブレードの、[**タグ**] ブレードを表示します。

1. [**タグ**] ブレードで、"**environment**" というタグの値として "**lab**" という値を設定してみます。エラー内容を確認します。


> **結果**: この演習では、偶発的な変更を防ぐために、リソース グループ レベルのロックを作成し、その機能を検証しました。
